## MQTT 技術規格

### 1. 連線配置
| 參數 | 值 |
|------|-----|
| 代理伺服器 | 支援 5 個預設伺服器 + 自訂伺服器 |
| 連接埠 | 1883（可自訂） |
| 認證方式 | 支援帳號密碼認證（選用） |
| 重連機制 | 智慧伺服器切換，失敗 3 次自動切換伺服器 |
| QoS 等級 | 0 |
| 連線策略 | 每次啟動選擇最快伺服器（1秒內連線即採用） |

### 2. 預設伺服器列表
| 序號 | 伺服器名稱 | 伺服器位址 | 埠號 | 需要認證 |
|------|------------|------------|------|----------|
| 1 | 台灣 MQTT Go | mqttgo.io | 1883 | ✗ |
| 2 | 齁斑社企 | broker.hoban.tw | 1883 | ✓ |
| 3 | Eclipse | mqtt.eclipseprojects.io | 1883 | ✗ |
| 4 | EMQX 公共 | broker.emqx.io | 1883 | ✗ |
| 5 | HiveMQ 公共 | broker.hivemq.com | 1883 | ✗ |

### 2.1 智慧連線機制
設備啟動時按以下優先順序連線：
1. **自訂伺服器**（如果有設定）
2. **上次成功的伺服器**
3. **循環測試所有預設伺服器**（1秒快速測試）

連線中如果失敗 3 次，會自動切換到下一個可用伺服器。

### 2.2 認證配置
- **預設伺服器認證**：寫死在韌體中，無需手動配置
- **自訂伺服器認證**：
  - 透過 BLE 配置：發送 JSON 包含 `mqtt_username` 和 `mqtt_password` 欄位
  - 透過 Web 介面：在 MQTT 設定表單中填寫帳號密碼（選用）
  - 儲存位置：EEPROM（帳號 16 bytes + 密碼 16 bytes）
  - 如果不需要認證，將欄位留空即可

### 3. 主題架構
```
狀態發布主題：hoban/{device_id}/status
控制訂閱主題：hoban/{device_id}/control
```

### 4. 控制指令集
| 指令 | 功能描述 |
|------|----------|
| status | 請求設備狀態回報 |
| ON | 觸發繼電器動作 |
| reset | 重置設備配置 |
| update | 觸發韌體更新程序 |

### 5. 狀態回報機制
- **回報頻率**：15秒/次
- **回報內容**：
  - 設備識別碼 (device_id)
  - 韌體版本號
  - WiFi 連線狀態
  - 系統記憶體使用量
- **離線檢測**：
  - 實作 Last Will and Testament (LWT)
  - 支援即時離線通知

### 6. LED 狀態指示
| 狀態 | LED 行為模式 |
|------|-------------|
| 韌體更新中 | 快速閃爍 (200ms 間隔) |
| AP 模式 | 慢速閃爍 (1000ms 間隔) |
| 正常運作 | 恆亮 |